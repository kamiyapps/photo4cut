<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“¸ ì¸ìƒë„¤ì»·</title>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      text-align: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      margin: 20px 0 30px;
      font-size: 32px;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    /* ì¹´ë©”ë¼ ì„¹ì…˜ */
    #cameraSection {
      margin-bottom: 20px;
    }

    #camera {
      position: relative;
      margin-bottom: 20px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background: #000;
      aspect-ratio: 3/4;
      max-width: 100%;
      margin: 0 auto;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    video.ready {
      display: block;
    }

    #countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 96px;
      font-weight: 800;
      color: #fff;
      text-shadow: 0 0 20px rgba(255,235,59,0.8),
                   0 0 40px rgba(255,235,59,0.6);
      display: none;
      animation: pulse 0.5s ease-in-out;
      z-index: 10;
    }

    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(255,255,255,0.7);
      font-size: 16px;
      padding: 40px 20px;
    }

    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 3px solid #fff;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ë©”ì‹œì§€ ë°•ìŠ¤ */
    .message-box {
      display: none;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: left;
      line-height: 1.6;
      font-size: 14px;
    }

    .message-box.show {
      display: block;
      animation: slideIn 0.5s ease-out;
    }

    #errorMessage {
      background: rgba(244, 67, 54, 0.9);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-box h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .retry-btn {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 20px;
      border: none;
      background: #fff;
      color: #f44336;
      cursor: pointer;
    }

    /* ì§„í–‰ ìƒíƒœ */
    #progress {
      margin: 15px 0;
      font-size: 14px;
      color: rgba(255,255,255,0.9);
      min-height: 20px;
      font-weight: 500;
    }

    .photo-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 15px 0;
      min-height: 12px;
    }

    .photo-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transition: all 0.3s ease;
    }

    .photo-dot.captured {
      background: #4caf50;
      box-shadow: 0 0 10px rgba(76,175,80,0.6);
    }

    /* ì„¤ì • ì„¹ì…˜ */
    .settings-section {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
    }

    .settings-section h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #fff;
    }

    /* ë°°ê²½ ì„ íƒ */
    .bg-selector {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .bg-btn {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .bg-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
    }

    .bg-btn.active {
      background: rgba(255,255,255,0.95);
      color: #667eea;
      border-color: #fff;
      box-shadow: 0 4px 12px rgba(255,255,255,0.3);
    }

    /* í•„í„° ì„ íƒ */
    #controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
      max-width: 100%;
      overflow-x: auto;
      padding: 5px;
    }

    .filter-btn {
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    .filter-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
    }

    .filter-btn.active {
      background: rgba(255,255,255,0.95);
      color: #667eea;
      border-color: #fff;
      box-shadow: 0 4px 12px rgba(255,255,255,0.3);
    }

    /* ì‹œì‘ ë²„íŠ¼ */
    #startBtn {
      padding: 16px 48px;
      font-size: 18px;
      font-weight: 700;
      border-radius: 30px;
      border: none;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 20px rgba(245,87,108,0.4);
      margin: 20px 0;
    }

    #startBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(245,87,108,0.5);
    }

    #startBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #999;
      box-shadow: none;
    }

    /* ê²°ê³¼ ì„¹ì…˜ */
    .result-section {
      margin-top: 30px;
    }

    #result {
      display: none;
      max-width: 100%;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      margin: 20px auto;
    }

    #result.show {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    #qr {
      display: none;
      max-width: 200px;
      padding: 10px;
      background: #fff;
      border-radius: 12px;
      margin: 15px auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    #qr.show {
      display: block;
      animation: fadeIn 0.5s ease-in 0.3s both;
    }

    .download-btn {
      margin-top: 15px;
      padding: 12px 32px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 25px;
      border: none;
      background: #fff;
      color: #667eea;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    canvas {
      display: none;
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 26px;
      }

      #countdown {
        font-size: 72px;
      }

      #startBtn {
        padding: 14px 36px;
        font-size: 16px;
      }

      .filter-btn, .bg-btn {
        font-size: 12px;
        padding: 8px 14px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“¸ ì¸ìƒë„¤ì»·</h1>

  <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
  <div id="errorMessage" class="message-box">
    <h3>âš ï¸ ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜</h3>
    <p id="errorText"></p>
    <button class="retry-btn" onclick="requestCamera()">ë‹¤ì‹œ ì‹œë„</button>
  </div>

  <!-- ì¹´ë©”ë¼ ì„¹ì…˜ -->
  <div id="cameraSection">
    <div id="camera">
      <video id="video" autoplay playsinline muted></video>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        ì¹´ë©”ë¼ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...
      </div>
      <div id="countdown"></div>
    </div>

    <div class="photo-indicator" id="photoIndicator"></div>
    <div id="progress"></div>

    <!-- ì„¤ì • ì„¹ì…˜ -->
    <div class="settings-section">
      <h3>ğŸ¨ ë°°ê²½ ì„ íƒ</h3>
      <div class="bg-selector">
        <button class="bg-btn" onclick="setBackground('live', this)">ğŸ“¹ ì‹¤ì‹œê°„</button>
        <button class="bg-btn active" onclick="setBackground('gray', this)">âš« íšŒìƒ‰</button>
        <button class="bg-btn" onclick="setBackground('white', this)">âšª í™”ì´íŠ¸</button>
        <button class="bg-btn" onclick="setBackground('blur', this)">ğŸŒ«ï¸ íë¦¼</button>
      </div>

      <h3>âœ¨ í•„í„° ì„ íƒ</h3>
      <div id="controls">
        <button class="filter-btn" onclick="setFilter('none', this)">ì›ë³¸</button>
        <button class="filter-btn active" onclick="setFilter('soft', this)">ğŸŒ¸ ë½€ìƒ¤ì‹œ</button>
        <button class="filter-btn" onclick="setFilter('bright', this)">âœ¨ í™”ì‚¬</button>
        <button class="filter-btn" onclick="setFilter('grayscale(100%)', this)">âš« í‘ë°±</button>
        <button class="filter-btn" onclick="setFilter('sepia(80%)', this)">ğŸ“¸ ë¹ˆí‹°ì§€</button>
        <button class="filter-btn" onclick="setFilter('contrast(120%) saturate(150%)', this)">ğŸŒˆ ì„ ëª…</button>
        <button class="filter-btn" onclick="setFilter('vivid', this)">ğŸ¨ ìƒë™ê°</button>
        <button class="filter-btn" onclick="setFilter('film', this)">ğŸï¸ í•„ë¦„</button>
        <button class="filter-btn" onclick="setFilter('blue', this)">ğŸ’™ ë¸”ë£¨í†¤</button>
      </div>
    </div>

    <button id="startBtn" disabled>ì´¬ì˜ ì‹œì‘ ğŸ¬</button>
  </div>

  <!-- ê²°ê³¼ ì„¹ì…˜ -->
  <div class="result-section">
    <img id="result" alt="ì¸ìƒë„¤ì»· ê²°ê³¼" />
    <button class="download-btn" id="downloadBtn" style="display:none;" onclick="downloadImage()">
      ğŸ’¾ ì‚¬ì§„ ì €ì¥í•˜ê¸°
    </button>
    <img id="qr" alt="QR ì½”ë“œ" />
  </div>
</div>

<canvas id="canvas"></canvas>
<canvas id="bgCanvas" style="display:none;"></canvas>

<script>
/* =====================
   ì„¤ì •
===================== */
const CONFIG = {
  storeName: "ğŸ“¸ INSANG PHOTO",
  brandText: "KEEP YOURSELF ALIVE",
  autoResetSec: 30,
  photoAspectRatio: 3/4
};

/* =====================
   ì „ì—­ ë³€ìˆ˜
===================== */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const bgCanvas = document.getElementById("bgCanvas");
const countdownEl = document.getElementById("countdown");
const resultImg = document.getElementById("result");
const qrImg = document.getElementById("qr");
const startBtn = document.getElementById("startBtn");
const downloadBtn = document.getElementById("downloadBtn");
const progressEl = document.getElementById("progress");
const photoIndicatorEl = document.getElementById("photoIndicator");
const errorMessageEl = document.getElementById("errorMessage");
const errorTextEl = document.getElementById("errorText");
const loadingEl = document.getElementById("loading");

let photos = [];
let selectedFilter = "soft";  // ê¸°ë³¸ ë½€ìƒ¤ì‹œ
let selectedBackground = "gray";  // ê¸°ë³¸ íšŒìƒ‰
let isBusy = false;
let stream = null;

/* =====================
   í•„í„° í”„ë¦¬ì…‹
===================== */
const FILTER_PRESETS = {
  'none': 'none',
  'soft': 'brightness(105%) contrast(95%) saturate(110%) blur(0.3px)',  // ë½€ìƒ¤ì‹œ íš¨ê³¼
  'bright': 'brightness(115%) contrast(105%) saturate(120%)',  // í™”ì‚¬í•˜ê²Œ
  'vivid': 'saturate(200%) hue-rotate(10deg)',
  'film': 'grayscale(50%) sepia(30%)',
  'blue': 'saturate(80%) hue-rotate(180deg)'
};

/* =====================
   ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
===================== */
async function requestCamera() {
  errorMessageEl.classList.remove('show');
  loadingEl.style.display = 'flex';
  video.classList.remove('ready');
  
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: "user",
        width: { ideal: 1080 },
        height: { ideal: 1440 }
      },
      audio: false
    });

    video.srcObject = stream;
    
    await new Promise((resolve, reject) => {
      video.onloadedmetadata = () => {
        video.play()
          .then(resolve)
          .catch(reject);
      };
      setTimeout(() => reject(new Error('Video load timeout')), 5000);
    });

    loadingEl.style.display = 'none';
    video.classList.add('ready');
    startBtn.disabled = false;
    progressEl.textContent = "âœ… ì¤€ë¹„ ì™„ë£Œ! ì´¬ì˜ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”";
    progressEl.style.color = "#4caf50";

  } catch (err) {
    console.error('Camera error:', err);
    loadingEl.style.display = 'none';
    showError(err);
  }
}

/* =====================
   ì—ëŸ¬ ì²˜ë¦¬
===================== */
function showError(err) {
  let message = `
    <strong>ì¹´ë©”ë¼ ì ‘ê·¼ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</strong><br><br>
    ${err.message || err.name}<br><br>
    <strong>í•´ê²° ë°©ë²•:</strong><br>
    1. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”<br>
    2. HTTPS ì—°ê²°ì¸ì§€ í™•ì¸í•˜ì„¸ìš”<br>
    3. ë‹¤ë¥¸ ì•±ì—ì„œ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš© ì¤‘ì´ì§€ ì•Šì€ì§€ í™•ì¸í•˜ì„¸ìš”
  `;
  
  errorTextEl.innerHTML = message;
  errorMessageEl.classList.add('show');
  startBtn.disabled = true;
}

/* =====================
   ë°°ê²½ ì„ íƒ
===================== */
function setBackground(bg, btn) {
  selectedBackground = bg;
  
  document.querySelectorAll('.bg-btn').forEach(b => {
    b.classList.remove('active');
  });
  
  if (btn) {
    btn.classList.add('active');
  }
}

/* =====================
   í•„í„° ì„ íƒ
===================== */
function setFilter(filter, btn) {
  selectedFilter = filter;
  
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.remove('active');
  });
  
  if (btn) {
    btn.classList.add('active');
  }
  
  // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° (ë°°ê²½ì´ liveì¼ ë•Œë§Œ)
  if (selectedBackground === 'live') {
    video.style.filter = FILTER_PRESETS[filter] || filter;
  }
}

/* =====================
   í¬í†  ì¸ë””ì¼€ì´í„°
===================== */
function initPhotoIndicator() {
  photoIndicatorEl.innerHTML = '';
  for (let i = 0; i < 4; i++) {
    const dot = document.createElement('div');
    dot.className = 'photo-dot';
    dot.id = `dot-${i}`;
    photoIndicatorEl.appendChild(dot);
  }
}

/* =====================
   ì´¬ì˜ ì‹œì‘
===================== */
startBtn.onclick = async () => {
  if (isBusy || !stream) return;
  
  isBusy = true;
  startBtn.disabled = true;
  startBtn.textContent = "ì´¬ì˜ ì¤‘...";
  
  resultImg.classList.remove('show');
  qrImg.classList.remove('show');
  downloadBtn.style.display = 'none';
  
  photos = [];
  initPhotoIndicator();
  
  for (let i = 0; i < 4; i++) {
    progressEl.textContent = `${i + 1}/4 ì¤€ë¹„...`;
    progressEl.style.color = "rgba(255,255,255,0.9)";
    await countdown(3);
    capture();
    document.getElementById(`dot-${i}`).classList.add('captured');
    progressEl.textContent = `${i + 1}/4 ì´¬ì˜ ì™„ë£Œ! âœ“`;
    progressEl.style.color = "#4caf50";
    await new Promise(resolve => setTimeout(resolve, 800));
  }

  progressEl.textContent = "ğŸ¨ ì‚¬ì§„ í•©ì„± ì¤‘...";
  progressEl.style.color = "rgba(255,255,255,0.9)";
  
  const finalCanvas = await combinePhotos();
  addDecoration(finalCanvas);
  
  resultImg.src = finalCanvas.toDataURL("image/png");
  resultImg.classList.add('show');
  downloadBtn.style.display = 'inline-block';
  
  progressEl.textContent = "QR ì½”ë“œ ìƒì„± ì¤‘...";
  await generateQR(finalCanvas);
  qrImg.classList.add('show');
  
  progressEl.textContent = `ğŸ‰ ì™„ì„±! (${CONFIG.autoResetSec}ì´ˆ í›„ ìë™ ì´ˆê¸°í™”)`;
  progressEl.style.color = "#4caf50";
  startBtn.textContent = "ì´¬ì˜ ì‹œì‘ ğŸ¬";

  setTimeout(resetKiosk, CONFIG.autoResetSec * 1000);
};

/* =====================
   ì¹´ìš´íŠ¸ë‹¤ìš´
===================== */
function countdown(sec) {
  return new Promise(resolve => {
    let count = sec;
    countdownEl.style.display = "block";
    countdownEl.textContent = count;

    const timer = setInterval(() => {
      count--;
      if (count === 0) {
        countdownEl.textContent = "ğŸ“¸";
      } else if (count < 0) {
        clearInterval(timer);
        countdownEl.style.display = "none";
        resolve();
      } else {
        countdownEl.textContent = count;
      }
    }, 1000);
  });
}

/* =====================
   ë°°ê²½ ìƒì„±
===================== */
function createBackground(width, height) {
  bgCanvas.width = width;
  bgCanvas.height = height;
  const ctx = bgCanvas.getContext("2d");
  
  switch(selectedBackground) {
    case 'gray':
      // íšŒìƒ‰ ê·¸ë¼ë°ì´ì…˜
      const grayGradient = ctx.createLinearGradient(0, 0, 0, height);
      grayGradient.addColorStop(0, '#b0b0b0');
      grayGradient.addColorStop(1, '#808080');
      ctx.fillStyle = grayGradient;
      ctx.fillRect(0, 0, width, height);
      break;
      
    case 'white':
      // í™”ì´íŠ¸
      ctx.fillStyle = '#f5f5f5';
      ctx.fillRect(0, 0, width, height);
      break;
      
    case 'blur':
      // íë¦° ë°°ê²½ (ë¹„ë””ì˜¤ ë¸”ëŸ¬)
      ctx.filter = 'blur(20px) brightness(0.8)';
      const vw = video.videoWidth;
      const vh = video.videoHeight;
      ctx.drawImage(video, 0, 0, vw, vh, 0, 0, width, height);
      ctx.filter = 'none';
      break;
      
    case 'live':
      // ì‹¤ì‹œê°„ ë°°ê²½ (í•„í„° ì—†ìŒ)
      break;
  }
  
  return bgCanvas;
}

/* =====================
   ì´¬ì˜
===================== */
function capture() {
  const targetWidth = 600;
  const targetHeight = 800;

  canvas.width = targetWidth;
  canvas.height = targetHeight;

  const ctx = canvas.getContext("2d");
  
  // ë°°ê²½ ê·¸ë¦¬ê¸°
  if (selectedBackground !== 'live') {
    const bg = createBackground(targetWidth, targetHeight);
    ctx.drawImage(bg, 0, 0);
  }

  // í•„í„° ì ìš©
  const filterValue = FILTER_PRESETS[selectedFilter] || selectedFilter;
  ctx.filter = filterValue;

  const vw = video.videoWidth;
  const vh = video.videoHeight;

  // 3:4 ë¹„ìœ¨ë¡œ í¬ë¡­
  const aspectRatio = 3 / 4;
  let cropW, cropH, sx, sy;

  if (vw / vh > aspectRatio) {
    cropH = vh;
    cropW = vh * aspectRatio;
    sx = (vw - cropW) / 2;
    sy = 0;
  } else {
    cropW = vw;
    cropH = vw / aspectRatio;
    sx = 0;
    sy = (vh - cropH) / 2;
  }

  // ë°°ê²½ì´ liveì¼ ê²½ìš° ì „ì²´ ê·¸ë¦¬ê¸°, ì•„ë‹ˆë©´ ì¤‘ì•™ì— ì‚¬ëŒë§Œ
  if (selectedBackground === 'live') {
    ctx.drawImage(video, sx, sy, cropW, cropH, 0, 0, targetWidth, targetHeight);
  } else {
    // ì‚¬ëŒ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì¤‘ì•™ 80%)
    const personScale = 0.8;
    const personWidth = targetWidth * personScale;
    const personHeight = targetHeight * personScale;
    const personX = (targetWidth - personWidth) / 2;
    const personY = (targetHeight - personHeight) / 2;
    
    ctx.drawImage(video, sx, sy, cropW, cropH, personX, personY, personWidth, personHeight);
  }
  
  // ë½€ìƒ¤ì‹œ íš¨ê³¼ ì¶”ê°€ (í•„í„°ê°€ softì¼ ë•Œ)
  if (selectedFilter === 'soft') {
    // ì•½ê°„ì˜ ê°€ìš°ì‹œì•ˆ ë¸”ëŸ¬ íš¨ê³¼
    ctx.filter = 'blur(0.5px)';
    ctx.globalAlpha = 0.3;
    ctx.drawImage(canvas, 0, 0);
    ctx.globalAlpha = 1.0;
    ctx.filter = 'none';
  }

  photos.push(canvas.toDataURL("image/png"));
}

/* =====================
   4ì»· í•©ì„±
===================== */
function combinePhotos() {
  return new Promise((resolve) => {
    const frameWidth = 600;
    const photoHeight = 800;
    const gap = 15;
    const topMargin = 120;
    const bottomMargin = 100;
    const sideMargin = 40;

    const out = document.createElement("canvas");
    out.width = frameWidth + (sideMargin * 2);
    out.height = topMargin + (photoHeight * 4) + (gap * 3) + bottomMargin;

    const ctx = out.getContext("2d");
    
    // íŒŒìŠ¤í…” ê·¸ë¼ë°ì´ì…˜ ë°°ê²½
    const gradient = ctx.createLinearGradient(0, 0, 0, out.height);
    gradient.addColorStop(0, '#D4F1F4');
    gradient.addColorStop(0.33, '#E8F5E9');
    gradient.addColorStop(0.66, '#FFF9E6');
    gradient.addColorStop(1, '#FFE5E5');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, out.width, out.height);

    let loadedCount = 0;
    
    photos.forEach((src, i) => {
      const img = new Image();
      img.onload = () => {
        const x = sideMargin;
        const y = topMargin + (i * (photoHeight + gap));
        
        // ì‚¬ì§„ì— ë‘¥ê·¼ ëª¨ì„œë¦¬ ì ìš©
        ctx.save();
        ctx.beginPath();
        ctx.roundRect(x, y, frameWidth, photoHeight, 20);
        ctx.clip();
        ctx.drawImage(img, x, y, frameWidth, photoHeight);
        ctx.restore();
        
        // ì‚¬ì§„ í…Œë‘ë¦¬ (ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì)
        ctx.shadowColor = 'rgba(0,0,0,0.15)';
        ctx.shadowBlur = 10;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 5;
        ctx.strokeStyle = 'rgba(255,255,255,0.9)';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.roundRect(x, y, frameWidth, photoHeight, 20);
        ctx.stroke();
        ctx.shadowColor = 'transparent';
        
        loadedCount++;
        
        if (loadedCount === photos.length) {
          resolve(out);
        }
      };
      img.src = src;
    });
  });
}

/* =====================
   ë°ì½”ë ˆì´ì…˜ ì¶”ê°€
===================== */
function addDecoration(canvas) {
  const ctx = canvas.getContext("2d");
  
  // ìƒë‹¨ ë¸Œëœë”©
  ctx.fillStyle = "#333";
  ctx.font = "bold 36px Arial";
  ctx.textAlign = "center";
  ctx.fillText(CONFIG.storeName, canvas.width / 2, 60);
  
  // í•˜ë‹¨ í…ìŠ¤íŠ¸
  ctx.fillStyle = "#666";
  ctx.font = "18px Arial";
  ctx.fillText(CONFIG.brandText, canvas.width / 2, canvas.height - 40);
  
  // ë‚ ì§œ
  const date = new Date().toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
  ctx.font = "16px Arial";
  ctx.fillText(date, canvas.width / 2, canvas.height - 15);
  
  // ì‚¬ì´ë“œ í…ìŠ¤íŠ¸ (ì„¸ë¡œë¡œ)
  ctx.save();
  ctx.translate(20, canvas.height / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillStyle = "rgba(100,100,255,0.3)";
  ctx.font = "bold 14px Arial";
  ctx.textAlign = "center";
  ctx.fillText("KEEP YOURSELF ALIVE", 0, 0);
  ctx.restore();
  
  ctx.save();
  ctx.translate(canvas.width - 20, canvas.height / 2);
  ctx.rotate(Math.PI / 2);
  ctx.fillStyle = "rgba(255,100,150,0.3)";
  ctx.font = "bold 14px Arial";
  ctx.textAlign = "center";
  ctx.fillText("PHOTOISM", 0, 0);
  ctx.restore();
  
  // ìˆ«ì í‘œì‹œ (ê° ì‚¬ì§„ ì˜†)
  const topMargin = 120;
  const photoHeight = 800;
  const gap = 15;
  
  for (let i = 0; i < 4; i++) {
    const y = topMargin + (i * (photoHeight + gap)) + photoHeight / 2;
    
    // ì™¼ìª½ ì‚¼ê°í˜•
    ctx.fillStyle = "rgba(100,150,255,0.4)";
    ctx.beginPath();
    ctx.moveTo(10, y - 10);
    ctx.lineTo(10, y + 10);
    ctx.lineTo(25, y);
    ctx.closePath();
    ctx.fill();
  }
}

/* =====================
   QR ìƒì„±
===================== */
function generateQR(canvas) {
  return new Promise((resolve) => {
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      qrImg.src =
        "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
        encodeURIComponent(url);
      
      qrImg.onload = () => resolve();
      qrImg.onerror = () => resolve();
    });
  });
}

/* =====================
   ë‹¤ìš´ë¡œë“œ
===================== */
function downloadImage() {
  const link = document.createElement('a');
  link.download = `ì¸ìƒë„¤ì»·_${new Date().getTime()}.png`;
  link.href = resultImg.src;
  link.click();
}

/* =====================
   ë¦¬ì…‹
===================== */
function resetKiosk() {
  resultImg.src = "";
  resultImg.classList.remove('show');
  qrImg.src = "";
  qrImg.classList.remove('show');
  downloadBtn.style.display = 'none';
  photos = [];
  photoIndicatorEl.innerHTML = '';
  progressEl.textContent = "âœ… ì¤€ë¹„ ì™„ë£Œ! ì´¬ì˜ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”";
  progressEl.style.color = "#4caf50";
  startBtn.disabled = false;
  startBtn.textContent = "ì´¬ì˜ ì‹œì‘ ğŸ¬";
  isBusy = false;
  
  if (selectedBackground === 'live') {
    video.style.filter = FILTER_PRESETS[selectedFilter] || selectedFilter;
  }
}

/* =====================
   ì´ˆê¸°í™”
===================== */
window.addEventListener('load', () => {
  initPhotoIndicator();
  requestCamera();
});

window.addEventListener('beforeunload', () => {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¸ìƒë„¤ì»·</title>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      text-align: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      margin: 20px 0 30px;
      font-size: 32px;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      letter-spacing: -0.5px;
    }

    #camera {
      position: relative;
      margin-bottom: 20px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background: #000;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      display: none;
      background: #000;
    }

    video.ready {
      display: block;
    }

    #countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 96px;
      font-weight: 800;
      color: #fff;
      text-shadow: 0 0 20px rgba(255,235,59,0.8),
                   0 0 40px rgba(255,235,59,0.6);
      display: none;
      animation: pulse 0.5s ease-in-out;
      z-index: 10;
    }

    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
    }

    /* ì—ëŸ¬/ì•ˆë‚´ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .message-box {
      display: none;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: left;
      line-height: 1.6;
    }

    .message-box.show {
      display: block;
      animation: slideIn 0.5s ease-out;
    }

    #errorMessage {
      background: rgba(244, 67, 54, 0.9);
    }

    #infoMessage {
      background: rgba(33, 150, 243, 0.9);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-box h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }

    .message-box p {
      margin: 8px 0;
      font-size: 14px;
      opacity: 0.95;
    }

    .message-box ol {
      margin: 10px 0;
      padding-left: 20px;
    }

    .message-box li {
      margin: 5px 0;
      font-size: 14px;
    }

    .action-btn {
      margin-top: 15px;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 25px;
      border: none;
      background: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-right: 10px;
    }

    .action-btn.primary {
      background: #fff;
      color: #f44336;
    }

    .action-btn.secondary {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    #progress {
      margin-top: 10px;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      min-height: 20px;
    }

    #controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .filter-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .filter-btn.active {
      background: rgba(255,255,255,0.9);
      color: #667eea;
      border-color: #fff;
      box-shadow: 0 4px 12px rgba(255,255,255,0.3);
    }

    #startBtn {
      padding: 16px 48px;
      font-size: 18px;
      font-weight: 700;
      border-radius: 30px;
      border: none;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 20px rgba(245,87,108,0.4);
      margin: 20px 0;
    }

    #startBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(245,87,108,0.5);
    }

    #startBtn:active:not(:disabled) {
      transform: translateY(0);
    }

    #startBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #999;
      box-shadow: none;
    }

    .result-section {
      margin-top: 30px;
    }

    #result, #qr {
      max-width: 100%;
      border-radius: 16px;
      margin-top: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background: #fff;
    }

    #result {
      display: none;
    }

    #result.show {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    #qr {
      display: none;
      padding: 10px;
      max-width: 220px;
      margin: 15px auto;
    }

    #qr.show {
      display: block;
      animation: fadeIn 0.5s ease-in 0.3s both;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    canvas {
      display: none;
    }

    .photo-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
      min-height: 12px;
    }

    .photo-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transition: all 0.3s ease;
    }

    .photo-dot.captured {
      background: #4caf50;
      box-shadow: 0 0 10px rgba(76,175,80,0.6);
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,255,255,0.7);
      font-size: 16px;
    }

    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 3px solid #fff;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 26px;
      }

      #countdown {
        font-size: 72px;
      }

      #startBtn {
        padding: 14px 36px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“¸ ì¸ìƒë„¤ì»·</h1>

  <!-- ì •ë³´ ë©”ì‹œì§€ -->
  <div id="infoMessage" class="message-box">
    <h3>ğŸ’¡ ì¤‘ìš” ì•ˆë‚´</h3>
    <p id="infoText"></p>
    <button class="action-btn secondary" onclick="hideInfo()">í™•ì¸</button>
  </div>

  <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
  <div id="errorMessage" class="message-box">
    <h3>âš ï¸ ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜</h3>
    <p id="errorText"></p>
    <button class="action-btn primary" onclick="requestCamera()">ê¶Œí•œ ë‹¤ì‹œ ìš”ì²­</button>
    <button class="action-btn secondary" onclick="showInfo()">í•´ê²° ë°©ë²• ë³´ê¸°</button>
  </div>

  <div id="camera">
    <video id="video" autoplay playsinline muted></video>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      ì¹´ë©”ë¼ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...
    </div>
    <div id="countdown"></div>
  </div>

  <div class="photo-indicator" id="photoIndicator"></div>
  <div id="progress"></div>

  <div id="controls">
    <button class="filter-btn active" onclick="setFilter('none', this)">ì›ë³¸</button>
    <button class="filter-btn" onclick="setFilter('grayscale(100%)', this)">í‘ë°±</button>
    <button class="filter-btn" onclick="setFilter('sepia(70%)', this)">ë¹ˆí‹°ì§€</button>
    <button class="filter-btn" onclick="setFilter('contrast(120%) saturate(150%)', this)">ì„ ëª…</button>
  </div>

  <button id="startBtn" disabled>ì´¬ì˜ ì‹œì‘ ğŸ¬</button>

  <div class="result-section">
    <img id="result" />
    <img id="qr" />
  </div>
</div>

<canvas id="canvas"></canvas>

<script>
/* =====================
   ì„¤ì •
===================== */
const CONFIG = {
  storeName: "INSANG PHOTO",
  autoResetSec: 20,
  frame: "" // í”„ë ˆì„ ì´ë¯¸ì§€ URL (ì„ íƒì‚¬í•­)
};

/* =====================
   ì „ì—­ ë³€ìˆ˜
===================== */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const countdownEl = document.getElementById("countdown");
const resultImg = document.getElementById("result");
const qrImg = document.getElementById("qr");
const startBtn = document.getElementById("startBtn");
const progressEl = document.getElementById("progress");
const photoIndicatorEl = document.getElementById("photoIndicator");
const errorMessageEl = document.getElementById("errorMessage");
const infoMessageEl = document.getElementById("infoMessage");
const errorTextEl = document.getElementById("errorText");
const infoTextEl = document.getElementById("infoText");
const loadingEl = document.getElementById("loading");

let photos = [];
let selectedFilter = "none";
let isBusy = false;
let stream = null;
let cameraTimeout = null;

/* =====================
   í”„ë¡œí† ì½œ ì²´í¬
===================== */
function checkProtocol() {
  const protocol = window.location.protocol;
  
  if (protocol === 'file:') {
    showInfo();
    infoTextEl.innerHTML = `
      <strong>âš ï¸ ë¡œì»¬ íŒŒì¼ë¡œ ì—´ë ¤ìˆìŠµë‹ˆë‹¤</strong><br><br>
      ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ <code>file://</code> í”„ë¡œí† ì½œì—ì„œëŠ” ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><br>
      <strong>í•´ê²° ë°©ë²•:</strong><br>
      1. ì´ íŒŒì¼ì„ ì›¹ ì„œë²„ì— ì—…ë¡œë“œí•˜ì„¸ìš” (GitHub Pages, Netlify, Vercel ë“±)<br>
      2. ë˜ëŠ” ë¡œì»¬ ì›¹ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:<br>
      <code style="background:rgba(0,0,0,0.3); padding:5px; border-radius:5px; display:inline-block; margin-top:5px;">
      python -m http.server 8000
      </code>
    `;
    return false;
  }
  
  if (protocol === 'http:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
    showInfo();
    infoTextEl.innerHTML = `
      <strong>âš ï¸ HTTPSê°€ í•„ìš”í•©ë‹ˆë‹¤</strong><br><br>
      ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ì¹´ë©”ë¼ëŠ” HTTPS ì—°ê²°ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
      í˜„ì¬ ì£¼ì†Œ: <code>${window.location.href}</code><br><br>
      <strong>í•´ê²° ë°©ë²•:</strong><br>
      1. HTTPSë¥¼ ì§€ì›í•˜ëŠ” í˜¸ìŠ¤íŒ… ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”<br>
      2. ë˜ëŠ” localhostì—ì„œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”
    `;
    return false;
  }
  
  return true;
}

/* =====================
   ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
===================== */
async function requestCamera() {
  // í”„ë¡œí† ì½œ ì²´í¬
  if (!checkProtocol()) {
    startBtn.disabled = true;
    return;
  }

  errorMessageEl.classList.remove('show');
  infoMessageEl.classList.remove('show');
  loadingEl.style.display = 'block';
  video.classList.remove('ready');
  
  // ì´ì „ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }

  // íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ)
  cameraTimeout = setTimeout(() => {
    if (!stream) {
      showError({
        name: 'TimeoutError',
        message: 'ì¹´ë©”ë¼ ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.'
      });
    }
  }, 10000);

  try {
    // ë¨¼ì € ê¶Œí•œ ìƒíƒœ í™•ì¸ (ì§€ì›í•˜ëŠ” ë¸Œë¼ìš°ì €ì˜ ê²½ìš°)
    if (navigator.permissions && navigator.permissions.query) {
      try {
        const result = await navigator.permissions.query({ name: 'camera' });
        console.log('Camera permission:', result.state);
        
        if (result.state === 'denied') {
          throw new Error('Permission denied');
        }
      } catch (e) {
        // ê¶Œí•œ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €
        console.log('Permissions API not supported');
      }
    }

    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ìš”ì²­
    stream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: "user",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });

    clearTimeout(cameraTimeout);
    
    video.srcObject = stream;
    
    // ë¹„ë””ì˜¤ê°€ ì‹¤ì œë¡œ ì¬ìƒ ê°€ëŠ¥í•  ë•Œê¹Œì§€ ëŒ€ê¸°
    await new Promise((resolve, reject) => {
      video.onloadedmetadata = () => {
        video.play()
          .then(resolve)
          .catch(reject);
      };
      
      // íƒ€ì„ì•„ì›ƒ ì„¤ì •
      setTimeout(() => reject(new Error('Video load timeout')), 5000);
    });

    // ì„±ê³µ!
    loadingEl.style.display = 'none';
    video.classList.add('ready');
    startBtn.disabled = false;
    progressEl.textContent = "âœ… ì¤€ë¹„ ì™„ë£Œ! ì´¬ì˜ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”";
    progressEl.style.color = "#4caf50";

  } catch (err) {
    clearTimeout(cameraTimeout);
    console.error('Camera error:', err);
    loadingEl.style.display = 'none';
    showError(err);
  }
}

/* =====================
   ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
===================== */
function showError(err) {
  let message = '';
  
  console.log('Error name:', err.name);
  console.log('Error message:', err.message);
  
  if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError' || err.message === 'Permission denied') {
    message = `
      <strong>ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤</strong><br><br>
      <strong>Android Chrome í•´ê²° ë°©ë²•:</strong><br>
      1. ì£¼ì†Œì°½ ì™¼ìª½ì˜ ğŸ”’ ë˜ëŠ” ğŸ›ˆ ì•„ì´ì½˜ í´ë¦­<br>
      2. "ê¶Œí•œ" ë˜ëŠ” "ì‚¬ì´íŠ¸ ì„¤ì •" í´ë¦­<br>
      3. "ì¹´ë©”ë¼"ë¥¼ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½<br>
      4. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨<br><br>
      <strong>ë˜ëŠ” ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ:</strong><br>
      ì„¤ì • â†’ ì‚¬ì´íŠ¸ ì„¤ì • â†’ ì¹´ë©”ë¼ â†’ ì´ ì‚¬ì´íŠ¸ í—ˆìš©
    `;
  } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
    message = `
      <strong>ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong><br><br>
      â€¢ ê¸°ê¸°ì— ì¹´ë©”ë¼ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”<br>
      â€¢ ë‹¤ë¥¸ ì•±ì—ì„œ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš© ì¤‘ì´ë©´ ì¢…ë£Œí•˜ì„¸ìš”
    `;
  } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
    message = `
      <strong>ì¹´ë©”ë¼ê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤</strong><br><br>
      ë‹¤ë¥¸ ì•±(ì¹´ë©”ë¼, í™”ìƒí†µí™” ë“±)ì„ ì¢…ë£Œí•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.
    `;
  } else if (err.name === 'NotSupportedError' || err.name === 'TypeError') {
    message = `
      <strong>ë¸Œë¼ìš°ì €ì—ì„œ ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</strong><br><br>
      â€¢ Chrome, Safari, Firefox ìµœì‹  ë²„ì „ì„ ì‚¬ìš©í•˜ì„¸ìš”<br>
      â€¢ HTTPS ì—°ê²°ì¸ì§€ í™•ì¸í•˜ì„¸ìš”
    `;
  } else if (err.name === 'TimeoutError') {
    message = `
      <strong>ì¹´ë©”ë¼ ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤</strong><br><br>
      â€¢ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”<br>
      â€¢ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”
    `;
  } else {
    message = `
      <strong>ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</strong><br><br>
      ì˜¤ë¥˜: ${err.name || 'Unknown'}<br>
      ë©”ì‹œì§€: ${err.message || 'No details'}<br><br>
      í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.
    `;
  }
  
  errorTextEl.innerHTML = message;
  errorMessageEl.classList.add('show');
  startBtn.disabled = true;
}

/* =====================
   ì •ë³´ ë©”ì‹œì§€
===================== */
function showInfo() {
  infoMessageEl.classList.add('show');
}

function hideInfo() {
  infoMessageEl.classList.remove('show');
}

/* =====================
   í•„í„° ì„ íƒ
===================== */
function setFilter(filter, btn) {
  selectedFilter = filter;
  
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.remove('active');
  });
  
  if (btn) {
    btn.classList.add('active');
  }
  
  video.style.filter = filter;
}

/* =====================
   í¬í†  ì¸ë””ì¼€ì´í„° ì´ˆê¸°í™”
===================== */
function initPhotoIndicator() {
  photoIndicatorEl.innerHTML = '';
  for (let i = 0; i < 4; i++) {
    const dot = document.createElement('div');
    dot.className = 'photo-dot';
    dot.id = `dot-${i}`;
    photoIndicatorEl.appendChild(dot);
  }
}

/* =====================
   ì‹œì‘ ë²„íŠ¼
===================== */
startBtn.onclick = async () => {
  if (isBusy || !stream) return;
  
  isBusy = true;
  startBtn.disabled = true;
  startBtn.textContent = "ì´¬ì˜ ì¤‘...";
  
  resultImg.classList.remove('show');
  qrImg.classList.remove('show');
  
  photos = [];
  initPhotoIndicator();
  
  for (let i = 0; i < 4; i++) {
    progressEl.textContent = `${i + 1}/4 ì¤€ë¹„...`;
    progressEl.style.color = "rgba(255,255,255,0.8)";
    await countdown(3);
    capture();
    document.getElementById(`dot-${i}`).classList.add('captured');
    progressEl.textContent = `${i + 1}/4 ì´¬ì˜ ì™„ë£Œ! âœ“`;
    progressEl.style.color = "#4caf50";
    await new Promise(resolve => setTimeout(resolve, 500));
  }

  progressEl.textContent = "ì‚¬ì§„ í•©ì„± ì¤‘...";
  progressEl.style.color = "rgba(255,255,255,0.8)";
  
  const finalCanvas = await combinePhotos();
  
  if (CONFIG.frame) {
    await drawFrame(finalCanvas);
  }
  
  drawMeta(finalCanvas);
  
  resultImg.src = finalCanvas.toDataURL("image/png");
  resultImg.classList.add('show');
  
  progressEl.textContent = "QR ì½”ë“œ ìƒì„± ì¤‘...";
  await generateQR(finalCanvas);
  qrImg.classList.add('show');
  
  progressEl.textContent = `ğŸ‰ ì™„ì„±! (${CONFIG.autoResetSec}ì´ˆ í›„ ìë™ ì´ˆê¸°í™”)`;
  progressEl.style.color = "#4caf50";
  startBtn.textContent = "ì´¬ì˜ ì‹œì‘ ğŸ¬";

  setTimeout(resetKiosk, CONFIG.autoResetSec * 1000);
};

/* =====================
   ì¹´ìš´íŠ¸ë‹¤ìš´
===================== */
function countdown(sec) {
  return new Promise(resolve => {
    let count = sec;
    countdownEl.style.display = "block";
    countdownEl.textContent = count;

    const timer = setInterval(() => {
      count--;
      if (count === 0) {
        countdownEl.textContent = "ğŸ“¸";
      } else if (count < 0) {
        clearInterval(timer);
        countdownEl.style.display = "none";
        resolve();
      } else {
        countdownEl.textContent = count;
      }
    }, 1000);
  });
}

/* =====================
   ì´¬ì˜
===================== */
function capture() {
  const w = 800;
  const h = 300;

  canvas.width = w;
  canvas.height = h;

  const ctx = canvas.getContext("2d");
  ctx.filter = selectedFilter;

  const vw = video.videoWidth;
  const vh = video.videoHeight;

  const cropW = vw * 0.7;
  const cropH = vh * 0.7;
  const sx = (vw - cropW) / 2;
  const sy = (vh - cropH) / 2;

  ctx.drawImage(video, sx, sy, cropW, cropH, 0, 0, w, h);
  photos.push(canvas.toDataURL("image/png"));
}

/* =====================
   4ì»· í•©ì„±
===================== */
function combinePhotos() {
  return new Promise((resolve) => {
    const out = document.createElement("canvas");
    out.width = 800;
    out.height = 1200;

    const ctx = out.getContext("2d");
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, out.width, out.height);

    let loadedCount = 0;
    
    photos.forEach((src, i) => {
      const img = new Image();
      img.onload = () => {
        ctx.drawImage(img, 0, i * 300, 800, 300);
        loadedCount++;
        
        if (loadedCount === photos.length) {
          resolve(out);
        }
      };
      img.src = src;
    });
  });
}

/* =====================
   í”„ë ˆì„
===================== */
function drawFrame(canvas) {
  return new Promise((resolve) => {
    if (!CONFIG.frame) {
      resolve();
      return;
    }
    
    const ctx = canvas.getContext("2d");
    const frame = new Image();
    
    frame.onload = () => {
      ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
      resolve();
    };
    
    frame.onerror = () => {
      resolve();
    };
    
    frame.src = CONFIG.frame;
  });
}

/* =====================
   ë‚ ì§œ / ë§¤ì¥ëª…
===================== */
function drawMeta(canvas) {
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#000";
  ctx.font = "bold 28px Arial";
  ctx.textAlign = "left";

  ctx.fillText(CONFIG.storeName, 20, 40);
  
  ctx.font = "20px Arial";
  const date = new Date().toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  ctx.fillText(date, 20, canvas.height - 20);
}

/* =====================
   QR ìƒì„±
===================== */
function generateQR(canvas) {
  return new Promise((resolve) => {
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      qrImg.src =
        "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
        encodeURIComponent(url);
      
      qrImg.onload = () => resolve();
      qrImg.onerror = () => resolve();
    });
  });
}

/* =====================
   ë¦¬ì…‹
===================== */
function resetKiosk() {
  resultImg.src = "";
  resultImg.classList.remove('show');
  qrImg.src = "";
  qrImg.classList.remove('show');
  photos = [];
  photoIndicatorEl.innerHTML = '';
  progressEl.textContent = "âœ… ì¤€ë¹„ ì™„ë£Œ! ì´¬ì˜ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”";
  progressEl.style.color = "#4caf50";
  startBtn.disabled = false;
  startBtn.textContent = "ì´¬ì˜ ì‹œì‘ ğŸ¬";
  isBusy = false;
  video.style.filter = selectedFilter;
}

/* =====================
   ì´ˆê¸°í™”
===================== */
window.addEventListener('load', () => {
  initPhotoIndicator();
  requestCamera();
});

/* =====================
   í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
===================== */
window.addEventListener('beforeunload', () => {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
  if (cameraTimeout) {
    clearTimeout(cameraTimeout);
  }
});
</script>

</body>
</html>
